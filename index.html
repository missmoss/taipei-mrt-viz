<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
            <title>Taipei MRT Flow by missmoss</title>
            <style>
                #map{ width: 100%; height: 800px; float: left;}
                </style>
            <meta name="viewport" content="width=device-width, initial-scale=1">
                <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
                    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
                        <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
                        <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
                        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
                        <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
                        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
                        <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
                        <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
                        <script src="http://d3js.org/d3.v3.min.js"></script>
                        <script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
                        </head>
                        <body>
                        <section class="page-header">
                        <h1 class="project-name">Taipei MRT Flow</h1>
                        <h2 class="project-tagline">台北捷運一日進出站流量</h2>
                        <a href="https://github.com/missmoss/taipei-mrt-viz" class="btn">View on GitHub</a>
                        <a href="https://github.com/missmoss/taipei-mrt-viz/zipball/master" class="btn">Download .zip</a>
                        <a href="https://github.com/missmoss/taipei-mrt-viz/tarball/master" class="btn">Download .tar.gz</a>
                        </section>
                        
                        
                        <section class="main-content">
                        <div id="map"></div>
                        
                        <h3>Project Description</h3>
                        
                        <p>This is </p>
                        
                        <h3>Data Source</h3>
                        Taipei MRT Station Flow: <a href="http://data.taipei/">Open Data Taipei</a></br>
                        Taipei MRT Station Location: <a href="https://github.com/repeat" class="user-mention">@repeat</a>/<a href="https://github.com/repeat/taipei-metro-stations">taipei-metro-stations</a>
                        <h3>Inspired By</h3>
                        Oliver O'Brien <a href="https://youtu.be/QQV3UHsZ_u4">Oyster Card Touch Ins & Touch Outs (Map Animation)</a></br>
                        Ira Winder <a href="http://cp.media.mit.edu/city-simulation/">Urban Intervention Simulation</a></br>
                        Mike Barry and Brian Card <a href="http://mbtaviz.github.io/">Visualizing MBTA Data</a>
                        
                        <footer class="site-footer">
                        <span class="site-footer-owner"><a href="https://github.com/missmoss/taipei-mrt-viz">Taipei-mrt-viz</a> is maintained by <a href="https://github.com/missmoss">missmoss</a>.</span>
                        
                        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
                        </footer>
                        
                        </section>
                        
                        <script>
                        /* Set up Leaflet.js map */
                        var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                        subdomain: 'abcd'
                        });
                        
                        var map = L.map('map', {
                        scrollWheelZoom: true,
                        center: [25.0600789,121.5171921],
                        zoom: 12,
                        zoomControl: false
                        });
                        
                        L.control.zoom({
                        position:'topright'
                        }).addTo(map);
                        
                        map.addLayer(layer);
                        
                        /* Initialize the SVG layer */
                        map._initPathRoot()
                        
                        /* Set up svg and some elements for charts */
                        
                        /* svg1 for Heatmap */
                        /* We simply pick up the SVG from the map object */
                        var svg1 = d3.select("#map").select("svg"),
                        g = svg1.append("g");
                        
                        var clock = g.append("text")
                        .attr("fill", "#6C6C6C")
                        .attr("x", 30)
                        .attr("y", 50)
                        .style("font-size", 32)
                        .text("00:00");
                        
                        
                        /* Load data, process and draw functions */
                        d3.csv("mrtflow_Nov2_2015.csv", function(data) {
                        
                        data.forEach(function(d) {
                        d.LatLng = new L.LatLng(d.lat, d.lon);
                        });
                        
                        
                        var radScale = d3.scale.sqrt().domain([10,5000]).rangeRound([3,12]);
                        
                        var legend = [10, 100, 1000, 10000];
                        
                        svg1.append("rect")
                        .attr("x", 750)
                        .attr("y", 700)
                        .attr("height", 80)
                        .attr("width", 250)
                        .attr("fill", "#6C6C6C")
                        .style("opacity", 0.2);
                        
                        svg1.append("text")
                        .attr("x", 755)
                        .attr("y", 712)
                        .attr("fill", "#6C6C6C")
                        .style("font-size", 14)
                        .text("Legend");
                        svg1.append("circle")
                        .attr("cx", 765)
                        .attr("cy", 728)
                        .attr("r", 5)
                        .attr("fill", "#FFE11A")
                        .style("opacity", 0.7);
                        svg1.append("text")
                        .attr("x", 780)
                        .attr("y", 732)
                        .text("In 進站");
                        svg1.append("circle")
                        .attr("cx", 830)
                        .attr("cy", 728)
                        .attr("r", 5)
                        .attr("fill", "#5bc0de")
                        .style("opacity", 0.7);
                        svg1.append("text")
                        .attr("x", 845)
                        .attr("y", 732)
                        .text("Out 出站");
                        
                        svg1.selectAll(".legend")
                        .data(legend)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d,i) { return 758+i*40+radScale(d-1)*2;})
                        .attr("cy", 750)
                        .attr("r", function(d) { return radScale(d);} )
                        .attr("fill", "#5bc0de")
                        .style("opacity", 0.7);
                        
                        svg1.selectAll(".legendtext")
                        .data(legend)
                        .enter()
                        .append("text")
                        .attr("x", function(d,i) { return 758+i*40+radScale(d-1)*2+radScale(d)+5;})
                        .attr("y", 755)
                        .text(function(d) { return d;});
                        var i = 0;
                        setInterval(function() {
                        if (i > 20) {
                        i = 0;
                        }
                        
                        if (i < 19) {
                            var h = i + 5;
                            }
                            else {
                            var h = i - 19;
                            }
                            
                            var h1 = parseInt(h / 10),h2 = h % 10;
                            
                            clock.text(h1+""+ h2+":00")
                            .transition()
                            .duration(50);
                            
                            d3.selectAll("#hour")
                            .remove();
                            draw(h);
                            
                            i++;
                            }, 1000);
                            function draw(h) {
                            
                            hData = data.filter(function(d) {
                            return d.hour == h;
                            })
                            
                            function color(input) {
                            if (input === "in") {
                            return "#FFE11A";
                            }
                            else if (input === "out") {
                            return "#5bc0de";
                            }
                            else {
                            return "steelblue";
                            }
                            }
                            
                            var div = d3.select("#map").append("div")
                            .attr("class", "tooltip")
                            .style("opacity", 0);
                            
                            var canvas = g.selectAll("circle")
                            .data(hData)
                            .enter();
                            
                            var feature = canvas.append("circle")
                            .style("opacity", .6)
                            .attr("fill", function(d) {return color(d.direction);})
                            .attr("r", function(d) {return radScale(d.flow); })
                            .attr("class", "circle")
                            .attr("click", "off")
                            .attr("id", "hour");
                            
                            map.on("viewreset", updateMap);
                            updateMap();
                            
                            function updateMap() {
                            feature.attr("transform",
                            function(d) {
                            d.x = map.latLngToLayerPoint(d.LatLng).x;
                            d.y = map.latLngToLayerPoint(d.LatLng).y;
                            return "translate("+
                            map.latLngToLayerPoint(d.LatLng).x +","+
                            map.latLngToLayerPoint(d.LatLng).y +")";
                            }
                            )};
                            
                            }// end of draw(h)
                            
                            }) // end of d3.csv()
                            </script>
                            
                            <div id="cp">
                                <div id="cptext">
                                    </br>
                                    <p>2016 | Claire Tsao</p>
                                </div>
                            </div>
                            </body>
</html>